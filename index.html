<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MMP Central (Supabase)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 880px; margin: 24px auto; padding: 0 16px; }
    h1 { margin-bottom: 6px; }
    .muted { color: #666; margin-top: 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 14px 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    label { display:block; font-weight: 600; margin-top: 8px; }
    input, button { padding: 10px; margin-top: 6px; width: 100%; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hidden { display: none; }
    pre { background: #fafafa; border: 1px solid #eee; padding: 10px; border-radius: 8px; overflow:auto; }
    .ok { color: #0a8; }
    .err { color: #c00; }
  </style>
</head>
<body>
  <h1>MMP Central (Supabase)</h1>
  <p class="muted">This test page proves you’re reading/writing to ONE central database.</p>

  <!-- 1) CONNECT -->
  <div class="card">
    <h3>Step 1 — Connect to Supabase</h3>
    <p>Find these in Supabase → <b>Project Settings → API</b>.</p>
    <label>Project URL</label>
    <input id="sbUrl" placeholder="https://xxxx.supabase.co" />
    <label>Anon Public Key</label>
    <input id="sbKey" placeholder="eyJhbGciOi..." />
    <button id="connectBtn">Connect</button>
    <div id="connMsg"></div>
  </div>

  <!-- 2) LOGIN -->
  <div class="card">
    <h3>Step 2 — Owner Login</h3>
    <p>Create users in Supabase → <b>Authentication → Users → Add user</b>.</p>
    <label>Email</label><input id="email" type="email" placeholder="owner@yourdomain.co.za" />
    <label>Password</label><input id="password" type="password" placeholder="••••••••" />
    <div class="row">
      <button id="loginBtn">Log in</button>
      <button id="logoutBtn">Log out</button>
    </div>
    <div id="authMsg"></div>
  </div>

  <!-- 3) APP (only visible after login) -->
  <div id="app" class="hidden">
    <div class="card">
      <h3>Step 3 — Add a Product</h3>
      <label>SKU *</label><input id="sku" placeholder="A2048201745" />
      <label>Name *</label><input id="name" placeholder="W204 Wiper Blades" />
      <label>Brand</label><input id="brand" placeholder="German Quality" />
      <label>Barcode</label><input id="barcode" placeholder="6000000000000" />
      <label>Category</label><input id="category" placeholder="Wipers" />
      <button id="addBtn">Add Product</button>
      <div id="addMsg"></div>
    </div>

    <div class="card">
      <h3>Step 4 — Search Products</h3>
      <input id="q" placeholder="Type part name (e.g., W204)..." />
      <button id="searchBtn">Search</button>
      <pre id="list"></pre>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // small helpers
    const $ = (id) => document.getElementById(id);
    const show = (id) => $(id).classList.remove("hidden");
    const hide = (id) => $(id).classList.add("hidden");

    let sb = null; // supabase client instance

    // 1) Connect
    $("connectBtn").onclick = () => {
      const url = $("sbUrl").value.trim();
      const key = $("sbKey").value.trim();
      if (!url || !key) { $("connMsg").innerHTML = '<span class="err">Enter URL + Key.</span>'; return; }
      try {
        sb = window.supabase.createClient(url, key);
        $("connMsg").innerHTML = '<span class="ok">Connected. Now log in.</span>';
      } catch (e) {
        $("connMsg").innerHTML = '<span class="err">Failed to init client: ' + e.message + '</span>';
      }
    };

    // 2) Login & Logout
    $("loginBtn").onclick = async () => {
      if (!sb) { $("authMsg").innerHTML = '<span class="err">Connect to Supabase first.</span>'; return; }
      const email = $("email").value.trim();
      const password = $("password").value;
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) { $("authMsg").innerHTML = '<span class="err">Login failed: ' + error.message + '</span>'; hide("app"); return; }
      $("authMsg").innerHTML = '<span class="ok">Logged in.</span>';
      show("app");
    };

    $("logoutBtn").onclick = async () => {
      if (!sb) return;
      await sb.auth.signOut();
      $("authMsg").innerHTML = '<span class="ok">Logged out.</span>';
      hide("app");
    };

    // 3) Add Product
    $("addBtn").onclick = async () => {
      if (!sb) { $("addMsg").innerHTML = '<span class="err">Connect & log in first.</span>'; return; }
      const row = {
        sku: $("sku").value.trim(),
        name: $("name").value.trim(),
        brand: $("brand").value.trim() || null,
        barcode: $("barcode").value.trim() || null,
        category: $("category").value.trim() || null,
        vat_rate: 0.15
      };
      if (!row.sku || !row.name) { $("addMsg").innerHTML = '<span class="err">SKU and Name are required.</span>'; return; }
      const { data, error } = await sb.from("products").insert([row]).select().single();
      if (error) { $("addMsg").innerHTML = '<span class="err">Error: ' + error.message + '</span>'; return; }
      $("addMsg").innerHTML = '<span class="ok">Added: ' + data.sku + ' — ' + data.name + '</span>';
      // clear fields
      ["sku","name","brand","barcode","category"].forEach(id => $(id).value = "");
    };

    // 4) Search
    $("searchBtn").onclick = async () => {
      if (!sb) { $("list").textContent = "Connect & log in first."; return; }
      const q = $("q").value.trim();
      const req = q
        ? sb.from("products").select("*").ilike("name", `%${q}%`).limit(100)
        : sb.from("products").select("*").limit(100);
      const { data, error } = await req;
      $("list").textContent = error ? ("Error: " + error.message) : JSON.stringify(data, null, 2);
    };
  </script>
</body>
</html>
